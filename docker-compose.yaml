services:
  cim-fastapi:
    image: goncaloferreirauva/cim-fastapi
    working_dir: /app
    ports:
      - "8000:8000"
    volumes:
      - ./.env:/app/.env:ro
      - ./allowed_emails.txt:/app/allowed_emails.txt

    command: >
      sh -lc '
        test -f /app/requirements.txt || { echo "requirements.txt missing"; exit 1; }
        pip install --no-cache-dir -r /app/requirements.txt &&
        exec uvicorn login_server:app --host 0.0.0.0 --port 8000 --root-path /gd-cim-api --proxy-headers
      '
    environment:
      - MONGO_URI=mongodb://145.100.131.14:27017,193.225.251.153:27017/?replicaSet=rs0

      
  metrics-db:
    image: mongo:7
    restart: unless-stopped
    volumes:
      - ./metricsdb/metrics_data:/data/db
      - ./.cert/mongo-keyfile:/etc/mongo-keyfile
    network_mode: host
    # ports:
    #   - "27017:27017"
    command: [
      "mongod", "--replSet", "rs0", "--bind_ip_all",
      "--keyFile", "/etc/mongo-keyfile", "--auth"
    ]
    env_file:
      - .env
    # healthcheck:
    #   test: ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand({ ping: 1 }).ok"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 10

  # metrics-db-2:
  #   image: mongo:7
  #   restart: unless-stopped
  #   command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
  #   volumes:
  #     - ./metricsdb/metrics_data_2:/data/db
  #   healthcheck:
  #     test: ["CMD-SHELL", "mongosh --quiet --eval \"db.adminCommand('ping').ok\" || exit 1"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 10

  # metrics-db-3:
  #   image: mongo:7
  #   restart: unless-stopped
  #   command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
  #   volumes:
  #     - ./metricsdb/metrics_data_3:/data/db
  #   healthcheck:
  #     test: ["CMD-SHELL", "mongosh --quiet --eval \"db.adminCommand('ping').ok\" || exit 1"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 10

  # This was the old single-node rs init; kept for reference.
  # mongo-rs-init:
  #   image: mongo:7
  #   depends_on:
  #     metrics-db:
  #       condition: service_healthy
  #   entrypoint: >
  #     bash -lc "
  #     mongosh --host metrics-db:27017 --quiet --eval '
  #       try {
  #         rs.status().ok
  #       } catch (e) {
  #         rs.initiate({_id:\"rs0\", members:[{_id:0, host:\"metrics-db:27017\"}]})
  #       }
  #     ';
  #     "
  #   restart: "no"

  # Replica set initialiser (runs once then exits)
  mongo-rs-init:
    image: mongo:7
    depends_on:
      metrics-db:   { condition: service_healthy }
    entrypoint:
      - bash
      - -lc
      - |
        set -e
        echo "Waiting for all Mongo nodes..."
        for h in metrics-db; do
          until mongosh --host "$$h:27017" --quiet --eval "db.adminCommand('ping').ok" >/dev/null 2>&1; do
            echo "  waiting for $$h"; sleep 2;
          done
        done
        echo "Initiating replica set if needed..."
        mongosh --host metrics-db:27017 --quiet <<'JS'
        try {
          if (!rs.status().ok) { throw new Error("not initiated"); }
          print("Replica set already OK");
        } catch (e) {
          rs.initiate({
            _id: "rs0",
            members: [
              { _id: 0, host: "145.100.131.14:27017", priority: 2 },
              { _id: 1, host: "193.225.251.153:27017", priority: 1 }
            ]
          });
          var ok = false; for (var i=0;i<60;i++){ 
            try { if (rs.status().ok) { ok = true; break; } } catch(e){}
            sleep(1000);
          }
          if (!ok) { throw new Error("replica set did not become OK in time"); }
          print("Replica set initiated");
        }
        JS
    restart: "no"

  postgres:
    image: postgres:16
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    ports: ["5432:5432"]
    volumes:
      - ./pg_data:/var/lib/postgresql/data
    restart: unless-stopped

  ci-retain-db-1:
    image: mongo:7
    command: ["mongod","--replSet","rs0","--bind_ip_all"]
    volumes: [ "./ci_retain_data_1:/data/db" ]
    restart: unless-stopped

  ci-retain-db-2:
    image: mongo:7
    command: ["mongod","--replSet","rs0","--bind_ip_all"]
    volumes: [ "./ci_retain_data_2:/data/db" ]
    restart: unless-stopped

  ci-retain-db-3:
    image: mongo:7
    command: ["mongod","--replSet","rs0","--bind_ip_all"]
    volumes: [ "./ci_retain_data_3:/data/db" ]
    restart: unless-stopped

  ci-retain-rs-init:
    image: mongo:7
    depends_on:
      ci-retain-db-1: { condition: service_started }
      ci-retain-db-2: { condition: service_started }
      ci-retain-db-3: { condition: service_started }
    entrypoint:
      - bash
      - -lc
      - |
        set -e
        echo "Waiting for ci-retain Mongo nodes..."
        for h in ci-retain-db-1 ci-retain-db-2 ci-retain-db-3; do
          until mongosh --host "$$h:27017" --quiet --eval "db.adminCommand('ping').ok" >/dev/null 2>&1; do
            echo "  waiting for $$h"; sleep 2;
          done
        done
        echo "Initiating ci-retain replica set if needed..."
        mongosh --host ci-retain-db-1:27017 --quiet <<'JS'
        try {
          if (!rs.status().ok) { throw new Error("not initiated"); }
          print("ci-retain replica set already OK");
        } catch (e) {
          rs.initiate({
            _id: "rs0",
            members: [
              { _id: 0, host: "ci-retain-db-1:27017" },
              { _id: 1, host: "ci-retain-db-2:27017" },
              { _id: 2, host: "ci-retain-db-3:27017" }
            ]
          });
          var ok = false; for (var i=0;i<60;i++){ 
            try { if (rs.status().ok) { ok = true; break; } } catch(e){}
            sleep(1000);
          }
          if (!ok) { throw new Error("ci-retain replica set did not become OK in time"); }
          print("ci-retain replica set initiated");
        }
        JS
    restart: "no"

  ci-calc:
    image: goncaloferreirauva/gd-ci-calc-service
    ports:
      - 8011:8011
    env_file: .env
    environment:
      - GD_CIM_BASE_URL=http://cim-fastapi:8000/gd-cim-api
      - GD_KPI_BASE_URL=http://kpi-service:8001/kpi-service
    volumes:
      - "./sites_data/sites_latlngpue.json:/data/sites_latlngpue.json:ro"
      - "./.cert:/etc/gocdb-cert:ro"
      
    command: uvicorn main:app --host 0.0.0.0 --port 8011 --log-level info

  # Simple publisher that streams Mongo inserts to the webhook
  mongo-stream-publisher:
    image: python:3.12-slim
    depends_on:
      ci-calc:  { condition: service_started }
      cim-fastapi: { condition: service_started }
    env_file:
      - .env
    environment:
      - MONGO_URI=mongodb://145.100.131.14:27017,193.225.251.153:27017/?replicaSet=rs0
      - WATCH_DB=metricsdb
      - WATCH_COLL=metrics
      - GD_BEARER_TOKEN=${JWT_TOKEN}
      - WEBHOOK_URL=http://ci-calc:8011/transform-and-forward
      # - SITES_URL=http://ci-calc:8011/load-sites
    # This is a mounted volume to have a real-time feedback while debugging. For the moment we do not need it.
    # volumes:
    #   - ./auth_metrics_server/publisher/publisher.py:/app/publisher.py:ro
    command: bash -lc "pip install --no-cache-dir pymongo requests python-dateutil && exec python -u /app/publisher.py"
    restart: unless-stopped

  kpi-service:
    image: goncaloferreirauva/gd-kpi-service
    ports:
      - "8001:8001"
    env_file: .env
    depends_on:
      ci-calc:  { condition: service_started }
    command: "uvicorn main:app --host 0.0.0.0 --port 8001 --reload --log-level debug"
    restart: unless-stopped

  auth-server:
    image: goncaloferreirauva/gd-auth-server
    ports:
      - "8002:8002"
    env_file: .env
    depends_on:
      cim-fastapi: { condition: service_started }
    command: "uvicorn main:app --host 0.0.0.0 --port 8002 --reload --log-level debug"
    restart: unless-stopped

  sql-cnr-adapter:
    image: goncaloferreirauva/gd-cnr-adapter-service
    ports:
      - 8033:8033
    # depends_on:
    #   ci-calc: { condition: service_healthy }
    env_file: .env
    restart: unless-stopped
    command: "uvicorn main:app --host 0.0.0.0 --port 8033 --reload --log-level debug"

secrets:
  mongo_keyfile:
    file: ./.secrets/mongo-keyfile
